services:
  cert-init:
    image: alpine:latest
    command:
      - /bin/sh
      - -ec
      - |
        apk add --no-cache openssl
        if [ ! -s /certs/certificate.crt ] || [ ! -s /certs/private_key.key ]; then
          openssl req -x509 -newkey rsa:2048 -sha256 -days 3650 -nodes \
            -keyout /certs/private_key.key \
            -out /certs/certificate.crt \
            -subj "/CN=umurmur"
        fi
    volumes:
      - umurmur-certs:/certs
    restart: "no"

  debian-gnutls:
    build:
      context: .
      args:
        - SSL=gnutls
      dockerfile: Dockerfile.debian
    depends_on:
      cert-init:
        condition: service_completed_successfully
    volumes:
      - umurmur-certs:/etc/umurmur:ro

  debian-mbedtls:
    build:
      context: .
      args:
        - SSL=mbedtls
      dockerfile: Dockerfile.debian
    depends_on:
      cert-init:
        condition: service_completed_successfully
    volumes:
      - umurmur-certs:/etc/umurmur:ro

  debian-openssl:
    build:
      context: .
      args:
        - SSL=openssl
      dockerfile: Dockerfile.debian
    depends_on:
      cert-init:
        condition: service_completed_successfully
    volumes:
      - umurmur-certs:/etc/umurmur:ro

  alpine-gnutls:
    build:
      context: .
      args:
        - SSL=gnutls
      dockerfile: Dockerfile.alpine
    depends_on:
      cert-init:
        condition: service_completed_successfully
    volumes:
      - umurmur-certs:/etc/umurmur:ro

  alpine-mbedtls:
    build:
      context: .
      args:
        - SSL=mbedtls
      dockerfile: Dockerfile.alpine
    depends_on:
      cert-init:
        condition: service_completed_successfully
    volumes:
      - umurmur-certs:/etc/umurmur:ro

  alpine-openssl:
    build:
      context: .
      args:
        - SSL=openssl
      dockerfile: Dockerfile.alpine
    depends_on:
      cert-init:
        condition: service_completed_successfully
    volumes:
      - umurmur-certs:/etc/umurmur:ro

volumes:
  umurmur-certs:

